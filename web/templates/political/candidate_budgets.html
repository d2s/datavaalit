{% extends "site_base.html" %}

{% load i18n static compress %}

{% block head_title %}Kunnallisvaaliehdokkaiden ennakkorahoitusilmoitukset{% endblock %}

{% block extra_style %}
<link rel="stylesheet" href="http://leaflet.cloudmade.com/dist/leaflet.css" />
<style>
#map {
	width: 500px;
	height: 650px;
}
.info {
	padding: 6px 8px;
	font: 14px/16px Arial, Helvetica, sans-serif;
	background: white;
	background: rgba(255,255,255,0.8);
	box-shadow: 0 0 15px rgba(0,0,0,0.2);
	border-radius: 5px;
}
.info h4 {
	margin: 0 0 5px;
	color: #777;
}
.legend {
	text-align: left;
	line-height: 18px;
	color: #555;
}
.legend i {
	width: 18px;
	height: 18px;
	float: left;
	margin-right: 8px;
	opacity: 0.7;
}
</style>
{% endblock %}

{% block extra_script %}
{% compress js %}
<script type="text/javascript" src="{% static "js/underscore.js" %}"></script>
{% endcompress %}

{% compress js %}
<script type="text/javascript" src="{% static "js/jquery.flot.js" %}"></script>
<script type="text/javascript" src="{% static "js/jquery.flot.time.js" %}"></script>
{% endcompress %}

{% compress js %}
<script type="text/javascript" src="{% static "js/leaflet.js" %}"></script>
{% endcompress %}

{% compress js %}
<script type="text/coffeescript">
muni_dict = {{ muni_json|safe }}
party_list = {{ party_json|safe }}

$.ajax '/api/v1/municipality/'
  dataType: 'json'
  data:
    limit: 1000
    format: 'geojson'
  error: (args1, args2) ->
    alert "{% trans "Communication with server failed" %}"
  success: (geojson) ->
    for feat in geojson.features
      muni = muni_dict[feat.id]
      # If the muni is not found, it doesn't have the stats.
      # We don't render those.
      if not muni
        feat.properties.render = false
      else
        feat.properties.render = true
        _.extend(feat.properties, muni)
    geojson.features = _.filter(geojson.features, (feat) ->
      return feat.properties.render
    )
    handle_geojson(geojson)

PARTY_COLORS =
  'RKP': "#FFD87D",
  'KOK': "#C7DDF3",
  'KESK': "#9FD18B",
  'KD': "#CCCCCC",
  'PS': "#69B3E3",
  'VIHR': "#DDE89A",
  'SDP': "#F9C0C7",
  'VAS': "#EC008C",
  'PIR': "#888888",
  'SKP': "red",


flot_data = []
for p in party_list
  data = []
  # Convert data into percentages
  for dd in p.disclosure_data
    perc = dd[1] / p.num_candidates
    data.push([dd[0], perc])
  # Include only parties that actually have candidates
  # submitting budgets.
  last_percent = data[data.length-1][1]
  if last_percent != 0.0
    args =
      data: data
      label: p.code
    if p.code of PARTY_COLORS
      args.color = PARTY_COLORS[p.code]
    flot_data.push args

flot_data = _.sortBy flot_data, (fd) ->
  return 1 - fd.data[data.length-1][1]

handle_geojson = (json) ->
  alert "Bug!"

init_map = ->
  south_west = new L.LatLng(61.5, 23.00)
  north_east = new L.LatLng(68.50, 29.00)
  bounds = new L.LatLngBounds(south_west, north_east)

  map = L.map('map',
    minZoom: 5,
    maxZoom: 7,
    # Some basic options to keep the map still and prevent
    # the user from zooming and such.
    scrollWheelZoom: true,
    touchZoom: true,
    doubleClickZoom: true,
    zoomControl: true,
    dragging: true
  ).fitBounds(bounds);

  cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/{styleId}/256/{z}/{x}/{y}.png',
    attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
    key: 'BC9A493B41014CAABB98F0471D759707',
    styleId: 22677
  ).addTo(map);

  # control that shows state info on hover
  info = L.control();

  info.onAdd = (map) ->
    @._div = L.DomUtil.create('div', 'info');
    @.update();
    @._div;
  info.update = (props) ->
    console.log props
    s = '<h4>Vaalirahoituksen ennakkoilmoituksen</h4><h4>tehneiden ehdokkaiden osuus</h4>'
    if props
      perc = props.num_submitted / props.num_candidates
      s += '<b>' + props.name + '</b> (' + props.num_candidates + ' ehdokasta)' + '<br />' + (perc * 100).toFixed(0) + ' % tehnyt ennakkoilmoituksen'
    else
      s += 'Vie osoitin kunnan päälle'
    @._div.innerHTML = s
  info.addTo(map);
  # get color depending on population density value
  get_color = (d) ->
    if d > 0.40
      c = '#1A9850'
    else if d > 0.30
      c = '#91CF60'
    else if d > 0.20
      c = '#D9EF8B'
    else if d > 0.10
      c = '#FEE08B'
    else if d > 0.01
      c = '#FC8D59'
    else
      c = '#D73027'
    return c

  style = (feature) ->
    props = feature.properties
    perc = props.num_submitted / props.num_candidates
    return {
      fillColor: get_color(perc)
      weight: 1
      color: '#666'
      opacity: 0.6
      fillOpacity: 1.0
    }
  highlight_feature = (e) ->
    layer = e.target;

    layer.setStyle
      weight: 5,
      color: '#666',
      dashArray: '',
      fillOpacity: 0.7
    if (!L.Browser.ie && !L.Browser.opera)
      layer.bringToFront()
    info.update(layer.feature.properties)

  reset_highlight = (e) ->
    geojson.resetStyle(e.target)
    info.update()

  zoom_to_feature = (e) ->
    map.fitBounds(e.target.getBounds())

  on_each_feature = (feature, layer) ->
    layer.on
      mouseover: highlight_feature,
      mouseout: reset_highlight,
      click: zoom_to_feature

  legend = L.control({position: 'bottomright'})
  legend.onAdd = (map) ->
    div = L.DomUtil.create('div', 'info legend')
    grades = [0.0, 0.01, 0.10, 0.20, 0.30, 0.40]
    labels = []
    for i in [0..grades.length-1]
      from = grades[i]
      from_pr = (from * 100).toFixed(0)
      to = grades[i + 1]
      to_pr = (to * 100).toFixed(0)
      s = '<i style="background:' + get_color(from + 0.01) + '"></i> ' + from_pr + ' % '
      if to
        s += ' &ndash; ' + to_pr + ' % '
      else
        s += '+'
      labels.push(s)
    div.innerHTML = labels.join('<br>')
    return div
  legend.addTo(map)

  geojson = {}
  handle_geojson = (json_data) ->
    console.log "handle_geojson"
    geojson = L.geoJson(json_data,
      style: style,
      onEachFeature: on_each_feature
    ).addTo(map)

# The code below is run after the HTML document has finished loading.
jQuery ->
  $.plot $("#party-graph"), flot_data,
    series:
      lines:
        show: true
    xaxis:
      mode: "time"
      timeformat: "%d.%m."
    yaxis:
      tickFormatter: (num, obj) ->
        return "" + (num * 100).toFixed(0) + " %"
    grid:
      hoverable: true
    legend:
      container: $("#party-legend")
  init_map()
</script>
{% endcompress %}
{% endblock %}

{% block body %}
  <h1 style="font-size: 26px;">Kunnallisvaaliehdokkaiden 2012 ennakkorahoitusilmoitukset</h1>
  <div style="position: relative">
    <div id="party-graph" style="width: 600px; height: 300px;"></div>
    <div id="party-legend" style="position: absolute; left: 600px; top: 20px"></div>
  </div>
  <div id="map"></div>
{% endblock %}

